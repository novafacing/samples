# Get all immediate subdirectories that contain a Makefile
BROKEN_CHALLENGES :=
BROKEN_CHALLENGES += CROMU_00021 # C++
BROKEN_CHALLENGES += CROMU_00023 # C++
BROKEN_CHALLENGES += CROMU_00026 # C++
BROKEN_CHALLENGES += CROMU_00042 # C++
BROKEN_CHALLENGES += CROMU_00044 # C++
BROKEN_CHALLENGES += CROMU_00054 # C++
BROKEN_CHALLENGES += CROMU_00061 # C++
BROKEN_CHALLENGES += CROMU_00063 # C++
BROKEN_CHALLENGES += CROMU_00064 # C++
BROKEN_CHALLENGES += CROMU_00066 # C++
BROKEN_CHALLENGES += CROMU_00070 # C++
BROKEN_CHALLENGES += CROMU_00077 # C++
BROKEN_CHALLENGES += CROMU_00082 # C++
BROKEN_CHALLENGES += CROMU_00084 # C++
BROKEN_CHALLENGES += CROMU_00093 # C++
BROKEN_CHALLENGES += KPRCA_00052 # C++
BROKEN_CHALLENGES += KPRCA_00053 # C++
BROKEN_CHALLENGES += KPRCA_00054 # C++
BROKEN_CHALLENGES += KPRCA_00068 # C++
BROKEN_CHALLENGES += KPRCA_00077 # C++
BROKEN_CHALLENGES += KPRCA_00081 # C++
BROKEN_CHALLENGES += KPRCA_00097 # C++
BROKEN_CHALLENGES += KPRCA_00099 # C++
BROKEN_CHALLENGES += KPRCA_00100 # C++
BROKEN_CHALLENGES += KPRCA_00101 # C++
BROKEN_CHALLENGES += KPRCA_00102 # C++
BROKEN_CHALLENGES += KPRCA_00112 # C++
BROKEN_CHALLENGES += KPRCA_00119 # C++
BROKEN_CHALLENGES += KPRCA_00120 # C++
BROKEN_CHALLENGES += TNETS_00002 # C++
BROKEN_CHALLENGES += YAN01_00007 # C++
BROKEN_CHALLENGES += CROMU_00063 # Multi-cb
BROKEN_CHALLENGES += CROMU_00093 # Multi-cb
BROKEN_CHALLENGES += EAGLE_00004 # Multi-cb
BROKEN_CHALLENGES += KPRCA_00016 # Multi-cb
BROKEN_CHALLENGES += KPRCA_00024 # Multi-cb
BROKEN_CHALLENGES += KPRCA_00048 # Multi-cb
BROKEN_CHALLENGES += KPRCA_00075 # Multi-cb
BROKEN_CHALLENGES += KPRCA_00093 # Multi-cb
BROKEN_CHALLENGES += KPRCA_00111 # Multi-cb
BROKEN_CHALLENGES += LUNGE_00005 # Multi-cb
BROKEN_CHALLENGES += NRFIN_00006 # Multi-cb
BROKEN_CHALLENGES += NRFIN_00066 # Multi-cb
BROKEN_CHALLENGES += NRFIN_00067 # Multi-cb
BROKEN_CHALLENGES += NRFIN_00072 # Multi-cb
BROKEN_CHALLENGES += YAN01_00009 # Multi-cb
BROKEN_CHALLENGES += KPRCA_00025 # Wacky multiple definitions (weird OO)
BROKEN_CHALLENGES += KPRCA_00026 # Wacky redefinitions/undefined references
BROKEN_CHALLENGES += KPRCA_00044 # Invalid const indexing
BROKEN_CHALLENGES += KPRCA_00049 # Unsure what the issue here is
BROKEN_CHALLENGES += KPRCA_00087 # Unsure what the issue here is
BROKEN_CHALLENGES += NRFIN_00074 # Unsure what the issue here is
BROKEN_CHALLENGES += YAN01_00015 # Requires python2 in build to gen header

MKDIR ?= mkdir

SUBDIRS                := $(patsubst %/Makefile,%,$(wildcard */Makefile))
SUBDIRS                := $(filter-out $(BROKEN_CHALLENGES),$(SUBDIRS))
TOPLEVEL_BUILD_DIR     := build
TOPLEVEL_BUILD_BIN_DIR := $(abspath $(TOPLEVEL_BUILD_DIR)/bin)

# Default target
all: build

build: prep $(SUBDIRS)

# Prepare build environment (directories)
prep:
	$(MKDIR) -p $(TOPLEVEL_BUILD_BIN_DIR)

# Clean target
clean:
	@for dir in $(SUBDIRS); do \
		echo "Cleaning $$dir..."; \
		$(MAKE) -C $$dir clean; \
	done
	rm -rf $(TOPLEVEL_BUILD_BIN_DIR)

# Pattern rule for building subdirectories
$(SUBDIRS):
	@echo "Building $@..."
	@$(MAKE) -C $@ all TOPLEVEL_BUILD_BIN_DIR=$(TOPLEVEL_BUILD_BIN_DIR)

# Parallel build support (make -j N)
.PHONY: $(SUBDIRS)

# Pass down any variables defined on the command line
$(SUBDIRS): MAKEOVERRIDES := $(MAKEOVERRIDES)

.PHONY: all clean